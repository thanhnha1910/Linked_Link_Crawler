<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinkedIn Prospect Finder v3</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #0a66c2;
            --primary-hover: #004182;
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --text-color: #1f2937;
            --border-color: #e5e7eb;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --accent: #6366f1;
        }

        * { box-sizing: border-box; }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--text-color);
            margin: 0;
            padding: 40px 20px;
            line-height: 1.6;
        }

        .container { max-width: 1600px; margin: 0 auto; }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }
        .header h1 {
            font-size: 2.5rem;
            font-weight: 800;
            margin: 0 0 10px 0;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
            margin: 0;
        }
        .badge {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            margin-top: 10px;
        }

        .card {
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
            padding: 32px;
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .section-title::before {
            content: '';
            width: 4px;
            height: 16px;
            background: var(--primary);
            border-radius: 2px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .form-group { margin-bottom: 0; }
        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
            font-size: 0.9rem;
        }
        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-family: inherit;
            font-size: 0.95rem;
            transition: all 0.2s;
            background: #fafafa;
        }
        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 4px rgba(10, 102, 194, 0.1);
        }
        
        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }
        .hint {
            font-size: 0.8rem;
            color: #6b7280;
            margin-top: 6px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        /* Advanced Options Toggle */
        .advanced-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: #f8fafc;
            border-radius: 10px;
            cursor: pointer;
            margin-bottom: 20px;
            border: 1px solid #e5e7eb;
            transition: all 0.2s;
        }
        .advanced-toggle:hover {
            background: #f1f5f9;
        }
        .advanced-toggle .icon {
            transition: transform 0.3s;
        }
        .advanced-toggle.open .icon {
            transform: rotate(180deg);
        }
        .advanced-options {
            display: none;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
            margin-top: 20px;
        }
        .advanced-options.show {
            display: block;
        }

        /* Submit Button */
        .btn-analyze {
            background: linear-gradient(135deg, #0a66c2 0%, #004182 100%);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            width: 100%;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .btn-analyze:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(10, 102, 194, 0.3);
        }
        .btn-analyze:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-export {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }
        .btn-export:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 20px rgba(16, 185, 129, 0.3);
        }

        /* Status Area */
        .status-area {
            margin-top: 24px;
            padding: 16px 20px;
            border-radius: 12px;
            background: #eff6ff;
            display: none;
            border-left: 4px solid var(--primary);
        }
        .status-area.success {
            background: #f0fdf4;
            border-color: #10b981;
        }
        .status-area.error {
            background: #fef2f2;
            border-color: #ef4444;
        }
        .status-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #e5e7eb;
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Results */
        .result-container { display: none; }
        
        /* Stats Summary */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        .stat-card {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            border: 1px solid #e5e7eb;
        }
        .stat-value {
            font-size: 2rem;
            font-weight: 800;
            color: var(--primary);
        }
        .stat-label {
            font-size: 0.8rem;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 4px;
        }
        .stat-card.hot .stat-value { color: #ef4444; }
        .stat-card.warm .stat-value { color: #f59e0b; }
        .stat-card.cold .stat-value { color: #3b82f6; }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 16px;
        }
        .result-title {
            font-size: 1.25rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .count-badge {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
        }

        /* Filter Tabs */
        .filter-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .filter-tab {
            padding: 8px 16px;
            border-radius: 20px;
            border: 2px solid #e5e7eb;
            background: white;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        .filter-tab:hover {
            border-color: var(--primary);
            color: var(--primary);
        }
        .filter-tab.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        .filter-tab.hot.active { background: #ef4444; border-color: #ef4444; }
        .filter-tab.warm.active { background: #f59e0b; border-color: #f59e0b; }
        .filter-tab.cold.active { background: #3b82f6; border-color: #3b82f6; }

        .table-wrapper {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        thead {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        }
        th {
            padding: 14px 12px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            text-transform: uppercase;
            font-size: 0.7rem;
            letter-spacing: 0.05em;
            white-space: nowrap;
            border-bottom: 2px solid #e5e7eb;
        }
        td {
            padding: 14px 12px;
            border-bottom: 1px solid #f3f4f6;
            vertical-align: middle;
        }
        tr:hover {
            background: #f8fafc;
        }
        tr:last-child td {
            border-bottom: none;
        }

        .cell-name {
            font-weight: 600;
            color: #111827;
        }
        .cell-company {
            color: #4b5563;
            font-weight: 500;
        }
        .cell-position {
            font-size: 0.85rem;
            color: #6b7280;
            max-width: 250px;
            line-height: 1.4;
        }
        
        /* Segment Badge */
        .segment-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        .segment-badge.hot {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }
        .segment-badge.warm {
            background: #fffbeb;
            color: #d97706;
            border: 1px solid #fde68a;
        }
        .segment-badge.cold {
            background: #eff6ff;
            color: #2563eb;
            border: 1px solid #bfdbfe;
        }

        /* Score Badge */
        .score-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-weight: 700;
            font-size: 0.85rem;
        }
        .score-badge.high {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }
        .score-badge.medium {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }
        .score-badge.low {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        /* Tags */
        .tag {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            background: linear-gradient(135deg, #e0e7ff 0%, #ddd6fe 100%);
            color: #4338ca;
            font-size: 0.7rem;
            font-weight: 500;
            margin: 2px;
            white-space: nowrap;
        }
        .tag.ai { background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%); color: #be185d; }
        .tag.tech { background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); color: #1d4ed8; }
        .tag.finance { background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); color: #047857; }
        .tag.ambassador { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); color: #b45309; }

        /* Action Buttons */
        .action-btns {
            display: flex;
            gap: 8px;
        }
        .btn-action {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.2s;
            border: none;
            cursor: pointer;
        }
        .btn-linkedin {
            background: linear-gradient(135deg, #0a66c2 0%, #004182 100%);
            color: white;
        }
        .btn-linkedin:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(10, 102, 194, 0.3);
        }
        .btn-copy {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #e5e7eb;
        }
        .btn-copy:hover {
            background: #e5e7eb;
        }
        .btn-copy.copied {
            background: #d1fae5;
            color: #047857;
            border-color: #a7f3d0;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }
        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* Connection count */
        .connection-info {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.8rem;
            color: #6b7280;
        }
        .connection-info svg {
            width: 14px;
            height: 14px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header h1 { font-size: 1.8rem; }
            .card { padding: 20px; }
            .form-grid { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #1f2937;
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 0.9rem;
            display: none;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>üîç LinkedIn Prospect Finder</h1>
        <p>Automated Lead Generation & Prospecting with AI Scoring</p>
        <div class="badge">‚ú® v3.0 - Enhanced Results with Lead Scoring</div>
    </div>

    <div class="card">
        <form id="searchForm">
            <div class="section-title">Search Criteria</div>
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">Search Keywords <span style="color:red">*</span></label>
                    <input type="text" id="queryInput" class="form-input" placeholder='e.g., "AI Ambassador" OR "CTO"' required>
                    <div class="hint">Use OR for multiple terms, quotes for exact match</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Location</label>
                    <select id="locationInput" class="form-select">
                        <option value="Hong Kong">üá≠üá∞ Hong Kong</option>
                        <option value="Vietnam">üáªüá≥ Vietnam</option>
                        <option value="Singapore">üá∏üá¨ Singapore</option>
                        <option value="Thailand">üáπüá≠ Thailand</option>
                        <option value="Malaysia">üá≤üáæ Malaysia</option>
                        <option value="Indonesia">üáÆüá© Indonesia</option>
                        <option value="Philippines">üáµüá≠ Philippines</option>
                        <option value="Taiwan">üáπüáº Taiwan</option>
                        <option value="Japan">üáØüáµ Japan</option>
                        <option value="South Korea">üá∞üá∑ South Korea</option>
                        <option value="Australia">üá¶üá∫ Australia</option>
                        <option value="United States">üá∫üá∏ United States</option>
                        <option value="United Kingdom">üá¨üáß United Kingdom</option>
                        <option value="">üåç Any Location</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Max Profiles</label>
                    <select id="maxProfilesInput" class="form-select">
                        <option value="10">10 profiles (Fast)</option>
                        <option value="20">20 profiles</option>
                        <option value="30">30 profiles (Max)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Industry (Optional)</label>
                    <select id="industryInput" class="form-select">
                        <option value="">Any Industry</option>
                        <option value="Technology">Technology</option>
                        <option value="Finance">Finance & Banking</option>
                        <option value="Healthcare">Healthcare</option>
                        <option value="Retail">Retail & E-commerce</option>
                        <option value="Manufacturing">Manufacturing</option>
                        <option value="Education">Education</option>
                        <option value="Marketing">Marketing & Advertising</option>
                        <option value="Consulting">Consulting</option>
                    </select>
                </div>

                <div class="form-group full-width">
                    <label class="form-label">Target Job Titles <span style="color:red">*</span></label>
                    <textarea id="titlesInput" class="form-textarea" placeholder="Founder, CEO, CTO, Director, Head of AI..." required>CEO, Founder, CTO, Director, Head, VP</textarea>
                    <div class="hint">Comma-separated list. Max 20 titles. Profiles with these titles will be prioritized.</div>
                </div>
            </div>

            <div class="advanced-toggle" onclick="toggleAdvanced()">
                <span>‚öôÔ∏è Advanced Options</span>
                <span class="icon">‚ñº</span>
            </div>
     
            <div class="advanced-options" id="advancedOptions">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Company Size</label>
                        <select id="companySizeInput" class="form-select">
                            <option value="">Any Size</option>
                            <option value="1-10">1-10 employees (Startup)</option>
                            <option value="11-50">11-50 employees</option>
                            <option value="51-200">51-200 employees</option>
                            <option value="201-500">201-500 employees</option>
                            <option value="501-1000">501-1000 employees</option>
                            <option value="1001+">1001+ employees (Enterprise)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Seniority Level</label>
                        <select id="seniorityInput" class="form-select">
                            <option value="">Any Level</option>
                            <option value="Entry">Entry Level</option>
                            <option value="Senior">Senior</option>
                            <option value="Manager">Manager</option>
                            <option value="Director">Director</option>
                            <option value="VP">VP</option>
                            <option value="CXO">CXO / Executive</option>
                            <option value="Owner">Owner / Partner</option>
                        </select>
                    </div>

                    <div class="form-group full-width">
                        <label class="form-label">Must Include Names (Optional)</label>
                        <input type="text" id="namesInput" class="form-input" placeholder="e.g., John Doe, Jane Smith">
                        <div class="hint">Comma-separated names that MUST appear in results if found</div>
                    </div>
                </div>
            </div>

            <button type="submit" id="searchBtn" class="btn-analyze">
                <span>üîç</span>
                <span>Start Searching</span>
            </button>
        </form>

        <div class="status-area" id="statusArea">
            <div class="status-content">
                <div id="statusIcon"><div class="spinner"></div></div>
                <div>
                    <div id="statusText" style="font-weight: 600;">Ready</div>
                    <div id="timerText" style="font-size: 0.85rem; color: #6b7280;"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="card result-container" id="resultCard">
        <!-- Stats Summary -->
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-value" id="totalCount">0</div>
                <div class="stat-label">Total Prospects</div>
            </div>
            <div class="stat-card hot">
                <div class="stat-value" id="hotCount">0</div>
                <div class="stat-label">üî• Hot Leads</div>
            </div>
            <div class="stat-card warm">
                <div class="stat-value" id="warmCount">0</div>
                <div class="stat-label">üå°Ô∏è Warm Leads</div>
            </div>
            <div class="stat-card cold">
                <div class="stat-value" id="coldCount">0</div>
                <div class="stat-label">‚ùÑÔ∏è Cold Leads</div>
            </div>
        </div>

        <div class="result-header">
            <div class="result-title">
                Found Prospects
                <span class="count-badge" id="countBadge">0</span>
            </div>
            <div style="display: flex; gap: 12px;">
                <button class="btn-export" onclick="exportTableToExcel()">
                    <span>üì•</span>
                    <span>Download Excel</span>
                </button>
                <button class="btn-export" style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);" onclick="copyAllEmails()">
                    <span>üìã</span>
                    <span>Copy All URLs</span>
                </button>
            </div>
        </div>

        <!-- Filter Tabs -->
        <div class="filter-tabs">
            <div class="filter-tab active" data-filter="all" onclick="filterTable('all', this)">All</div>
            <div class="filter-tab hot" data-filter="Hot" onclick="filterTable('Hot', this)">üî• Hot</div>
            <div class="filter-tab warm" data-filter="Warm" onclick="filterTable('Warm', this)">üå°Ô∏è Warm</div>
            <div class="filter-tab cold" data-filter="Cold" onclick="filterTable('Cold', this)">‚ùÑÔ∏è Cold</div>
        </div>
        
        <div class="table-wrapper">
            <table id="prospectsTable">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Score</th>
                        <th>Name</th>
                        <th>Position</th>
                        <th>Company</th>
                        <th>Industry / Tags</th>
                        <th>Location</th>
                        <th>Connections</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Toast -->
<div class="toast" id="toast">Copied to clipboard!</div>

<script>
    // ==========================================
    // ‚öôÔ∏è API CONFIGURATION
    // ==========================================
    const N8N_DOMAIN = 'https://n8n-nick.abapi.dev'; 
    const API_START = `${N8N_DOMAIN}/webhook/linkedin-prospect-finder-start`;
    const API_STATUS = `${N8N_DOMAIN}/webhook/linkedin-prospect-finder-status`;
    // ==========================================

    // Store all data for filtering
    let allProspects = [];

    // DOM Elements
    const searchForm = document.getElementById('searchForm');
    const searchBtn = document.getElementById('searchBtn');
    const statusArea = document.getElementById('statusArea');
    const statusText = document.getElementById('statusText');
    const statusIcon = document.getElementById('statusIcon');
    const resultCard = document.getElementById('resultCard');
    const tableBody = document.getElementById('tableBody');
    const countBadge = document.getElementById('countBadge');
    
    let pollInterval;
    let startTime;

    function toggleAdvanced() {
        const options = document.getElementById('advancedOptions');
        const toggle = document.querySelector('.advanced-toggle');
        options.classList.toggle('show');
        toggle.classList.toggle('open');
    }

    // Form Submit
    searchForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const queryInput = document.getElementById('queryInput');
        if (!queryInput.value.trim()) {
            alert("Please enter a search keyword to proceed.");
            queryInput.focus();
            return;
        }
        
        searchBtn.disabled = true;
        searchBtn.innerHTML = '<div class="spinner"></div> Starting...';
        resultCard.style.display = 'none';
        
        // Collect form data
        const query = queryInput.value.trim();
        const location = document.getElementById('locationInput').value;
        const maxProfiles = parseInt(document.getElementById('maxProfilesInput').value);
        const industry = document.getElementById('industryInput').value;
        const companySize = document.getElementById('companySizeInput').value;
        const seniority = document.getElementById('seniorityInput').value;
        const titlesRaw = document.getElementById('titlesInput').value;
        const namesRaw = document.getElementById('namesInput').value;
        
        const decisionTitles = titlesRaw.split(',').map(t => t.trim()).filter(t => t);
        const namesMustInclude = namesRaw ? namesRaw.split(',').map(n => n.trim()).filter(n => n) : [];

        const payload = {
            search_query: query,
            location: location,
            max_profiles: maxProfiles,
            decision_titles: decisionTitles,
            industry: industry,
            company_size: companySize,
            seniority: seniority,
            names_must_include: namesMustInclude
        };

        console.log('üì§ Sending payload:', payload);

        try {
            updateStatus('loading', 'Sending request to server...');
            
            const response = await fetch(API_START, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) throw new Error('Failed to start workflow');
            
            const data = await response.json();
            const jobId = data.jobId; 

            updateStatus('loading', `Job ID: ${jobId.slice(-8)}... Scanning LinkedIn (2-5 mins)`);
            startTime = Date.now();
            
            pollStatus(jobId);

        } catch (error) {
            console.error(error);
            updateStatus('error', `Error: ${error.message}`);
            searchBtn.disabled = false;
            searchBtn.innerHTML = '<span>üîç</span><span>Start Searching</span>';
        }
    });

    // Polling
    async function pollStatus(jobId) {
        pollInterval = setInterval(async () => {
            try {
                const elapsed = Math.round((Date.now() - startTime) / 1000);
                document.getElementById('timerText').innerText = `‚è±Ô∏è ${elapsed}s elapsed`;

                const res = await fetch(`${API_STATUS}?jobId=${jobId}`);
                const data = await res.json();

                if (data.status === 'completed') {
                    clearInterval(pollInterval);
                    updateStatus('success', '‚úÖ Scan completed successfully!');
                    searchBtn.disabled = false;
                    searchBtn.innerHTML = '<span>üîç</span><span>Start Searching</span>';
                    renderTable(data.result); 
                } else if (data.status === 'error' || data.status === 'completed-with-errors') {
                    clearInterval(pollInterval);
                    updateStatus('error', '‚ùå Workflow encountered an error.');
                    searchBtn.disabled = false;
                    searchBtn.innerHTML = '<span>üîç</span><span>Start Searching</span>';
                    if (data.result) renderTable(data.result);
                }
            } catch (err) {
                console.error('Polling error', err);
            }
        }, 3000);
    }

    // Render Table with new fields
    function renderTable(data) {
        allProspects = data || [];
        tableBody.innerHTML = ''; 
        resultCard.style.display = 'block';
        
        if (!data || data.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="9" class="empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <div>No prospects found matching your criteria.</div>
                        <div style="margin-top: 8px; font-size: 0.9rem;">Try adjusting your search keywords or location.</div>
                    </td>
                </tr>`;
            updateStats([]);
            return;
        }

        updateStats(data);
        countBadge.innerText = data.length;

        renderRows(data);
        resultCard.scrollIntoView({ behavior: 'smooth' });
    }

    function renderRows(data) {
        tableBody.innerHTML = '';
        
        data.forEach((item, index) => {
            // Generate tags HTML
            let tagsHtml = '';
            const tags = item.tags ? item.tags.split(',').map(t => t.trim()).filter(t => t) : [];
            tags.slice(0, 4).forEach(tag => {
                let tagClass = '';
                if (tag.toLowerCase().includes('ai')) tagClass = 'ai';
                else if (tag.toLowerCase().includes('tech')) tagClass = 'tech';
                else if (tag.toLowerCase().includes('finance')) tagClass = 'finance';
                else if (tag.toLowerCase().includes('ambassador')) tagClass = 'ambassador';
                tagsHtml += `<span class="tag ${tagClass}">${tag}</span>`;
            });
            if (!tagsHtml) tagsHtml = `<span class="tag">${item.industry || 'General'}</span>`;

            // Score badge class
            const score = item.lead_score || 0;
            let scoreClass = 'low';
            if (score >= 25) scoreClass = 'high';
            else if (score >= 15) scoreClass = 'medium';

            // Segment badge
            const segment = item.segment || 'Cold';
            const segmentClass = segment.toLowerCase();

            // LinkedIn URL - ∆∞u ti√™n linkedin_url, sau ƒë√≥ profile_url
            const linkedinUrl = item.linkedin_url || item.profile_url || '';

            const row = document.createElement('tr');
            row.setAttribute('data-segment', segment);
            row.innerHTML = `
                <td style="color: #9ca3af; font-weight: 500;">${item.row_number || index + 1}</td>
                <td>
                    <div class="score-badge ${scoreClass}">${score}</div>
                </td>
                <td>
                    <div class="cell-name">${item.personal_name || 'N/A'}</div>
                    <div class="segment-badge ${segmentClass}">${segment === 'Hot' ? 'üî•' : segment === 'Warm' ? 'üå°Ô∏è' : '‚ùÑÔ∏è'} ${segment}</div>
                </td>
                <td class="cell-position">${item.position || 'N/A'}</td>
                <td class="cell-company">${item.company_name || 'N/A'}</td>
                <td>${tagsHtml}</td>
                <td>${item.location || 'N/A'}</td>
                <td>
                    <div class="connection-info">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                        ${item.connection_count || 0}
                    </div>
                </td>
                <td>
                    <div class="action-btns">
                        ${linkedinUrl ? `
                            <a href="${linkedinUrl}" target="_blank" class="btn-action btn-linkedin" title="View LinkedIn Profile">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></svg>
                                View
                            </a>
                            <button class="btn-action btn-copy" onclick="copyUrl('${linkedinUrl}', this)" title="Copy URL">
                                <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                            </button>
                        ` : '<span style="color:#9ca3af">-</span>'}
                    </div>
                </td>
            `;
            tableBody.appendChild(row);
        });
    }

    function updateStats(data) {
        const total = data.length;
        const hot = data.filter(d => d.segment === 'Hot').length;
        const warm = data.filter(d => d.segment === 'Warm').length;
        const cold = data.filter(d => d.segment === 'Cold').length;

        document.getElementById('totalCount').innerText = total;
        document.getElementById('hotCount').innerText = hot;
        document.getElementById('warmCount').innerText = warm;
        document.getElementById('coldCount').innerText = cold;
        countBadge.innerText = total;
    }

    function filterTable(segment, element) {
        // Update active tab
        document.querySelectorAll('.filter-tab').forEach(tab => tab.classList.remove('active'));
        element.classList.add('active');

        // Filter data
        let filtered = allProspects;
        if (segment !== 'all') {
            filtered = allProspects.filter(p => p.segment === segment);
        }

        renderRows(filtered);
        countBadge.innerText = filtered.length;
    }

    function copyUrl(url, btn) {
        navigator.clipboard.writeText(url).then(() => {
            btn.classList.add('copied');
            btn.innerHTML = '<svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>';
            showToast('URL copied to clipboard!');
            setTimeout(() => {
                btn.classList.remove('copied');
                btn.innerHTML = '<svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>';
            }, 2000);
        });
    }

    function copyAllEmails() {
        const urls = allProspects
            .map(p => p.linkedin_url || p.profile_url)
            .filter(url => url)
            .join('\n');
        
        if (urls) {
            navigator.clipboard.writeText(urls).then(() => {
                showToast(`Copied ${urls.split('\n').length} URLs to clipboard!`);
            });
        } else {
            showToast('No URLs to copy');
        }
    }

    function showToast(message) {
        const toast = document.getElementById('toast');
        toast.innerText = message;
        toast.style.display = 'block';
        setTimeout(() => {
            toast.style.display = 'none';
        }, 3000);
    }

    // Status UI
    function updateStatus(type, msg) {
        statusArea.style.display = 'block';
        statusText.innerText = msg;
        statusArea.className = 'status-area';
        
        if (type === 'loading') {
            statusIcon.innerHTML = '<div class="spinner"></div>';
        } else if (type === 'success') {
            statusIcon.innerHTML = '‚úÖ';
            statusArea.classList.add('success');
        } else if (type === 'error') {
            statusIcon.innerHTML = '‚ùå';
            statusArea.classList.add('error');
        }
    }

    // Export Excel with all new fields
    function exportTableToExcel() {
        // Create data array for Excel
        const excelData = allProspects.map((item, index) => ({
            '#': item.row_number || index + 1,
            'Lead Score': item.lead_score || 0,
            'Segment': item.segment || 'Cold',
            'Name': item.personal_name || 'N/A',
            'Position': item.position || 'N/A',
            'Company': item.company_name || 'N/A',
            'Industry': item.industry || 'N/A',
            'Tags': item.tags || '',
            'Location': item.location || 'N/A',
            'Connections': item.connection_count || 0,
            'Followers': item.follower_count || 0,
            'Experience': item.working_experience || '',
            'About': item.about_summary || '',
            'LinkedIn URL': item.linkedin_url || item.profile_url || '',
            'Scraped At': item.scraped_at || ''
        }));

        const ws = XLSX.utils.json_to_sheet(excelData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Prospects");
        
        // Auto-size columns
        const colWidths = [
            { wch: 5 },  // #
            { wch: 10 }, // Score
            { wch: 8 },  // Segment
            { wch: 25 }, // Name
            { wch: 40 }, // Position
            { wch: 25 }, // Company
            { wch: 15 }, // Industry
            { wch: 30 }, // Tags
            { wch: 20 }, // Location
            { wch: 12 }, // Connections
            { wch: 12 }, // Followers
            { wch: 50 }, // Experience
            { wch: 50 }, // About
            { wch: 50 }, // URL
            { wch: 20 }, // Scraped At
        ];
        ws['!cols'] = colWidths;

        const timestamp = new Date().toISOString().slice(0,10);
        XLSX.writeFile(wb, `LinkedIn_Prospects_${timestamp}.xlsx`);
        showToast('Excel file downloaded!');
    }
</script>

</body>
</html>